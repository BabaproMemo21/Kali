name: Run Kali Linux Container

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Docker Compose & Curl
        run: |
          sudo apt update
          sudo apt install docker-compose curl -y

      - name: Create kali.yml
        run: |
          mkdir -p Kali
          cd Kali
          cat <<EOF > kali.yml
services:
  kali:
    image: kalilinux/kali-rolling
    container_name: kali
    environment:
      USERNAME: "kali"
      PASSWORD: "kali@123"
    devices:
      - /dev/kvm
      - /dev/net/tun
    cap_add:
      - NET_ADMIN
    ports:
      - "2222:22"       # SSH
      - "3389:3389/tcp" # RDP (kali içinde xrdp varsa)
      - "3389:3389/udp"
    stop_grace_period: 2m
EOF

      - name: Run Docker Compose
        run: |
          cd Kali
          docker-compose -f kali.yml up -d

      - name: Download Cloudflared
        run: |
          ARCH="amd64"
          URL="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-${ARCH}"
          curl -L "$URL" -o cloudflared
          chmod +x cloudflared

      - name: Start Cloudflared Tunnel
        run: |
          ./cloudflared tunnel --url http://localhost:2222 --no-autoupdate > cf_log.txt 2>&1 &
          echo "Cloudflare linki oluşturuluyor..."
          sleep 10
          for i in {1..30}; do
            LINK=$(grep -o "https://.*\.trycloudflare\.com" cf_log.txt | head -n1)
            if [[ -n "$LINK" ]]; then break; fi
            sleep 2
          done
          echo "SSH/RDP bağlantı linkin: $LINK"
          echo "$LINK" > link.txt

      - name: Upload Cloudflare RDP Link
        uses: actions/upload-artifact@v4
        with:
          name: cloudflare-kali-link
          path: link.txt

      - name: Sleep for 6 hours to keep container and tunnel alive
        run: |
          echo "6 saatlik Kali Linux oturumu başladı. BabaproMemo Tarafindan Yapilmistir!"
          sleep 21600
