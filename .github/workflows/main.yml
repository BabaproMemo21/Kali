name: Run Kali Linux RDP Container

on:
  workflow_dispatch:

jobs:
  deploy:
    # KVM gerekiyorsa: self-hosted runner kullan. GitHub hosted runner'larda /dev/kvm genelde yok.
    runs-on: self-hosted
    timeout-minutes: 360

    steps:
      - name: Install Docker & Docker Compose & Curl
        run: |
          sudo apt-get update
          sudo apt-get install -y docker.io docker-compose curl

      - name: Create docker-compose file (kali.yml)
        run: |
          mkdir -p Kali
          cd Kali
          cat > kali.yml <<'EOF'
version: "3.9"
services:
  kali:
    image: dockurr/linux
    container_name: kali
    environment:
      DISTRO: "kali"
      ISO: "https://cdimage.kali.org/current/kali-linux-2024.3-installer-amd64.iso"
      VERSION: "2024.3"
      USERNAME: "MASTER"
      PASSWORD: "admin@123"
      RAM_SIZE: "8G"
      CPU_CORES: "4"
      DISK_SIZE: "100G"
    devices:
      - /dev/kvm
      - /dev/net/tun
    cap_add:
      - NET_ADMIN
    ports:
      - "8007:8006"       # Web arayÃ¼z
      - "5901:5900"       # VNC
      - "33891:3389/tcp"  # RDP TCP
      - "33891:3389/udp"  # RDP UDP
    stop_grace_period: 2m
 
 EOF

      - name: Run Docker Compose
        run: |
          cd Kali
          docker-compose -f kali.yml up -d

      - name: Download Cloudflared
        run: |
          ARCH="amd64"
          URL="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-${ARCH}"
          curl -L "$URL" -o cloudflared
          chmod +x cloudflared

      - name: Start Cloudflared Tunnel (Web UI on 8007)
        run: |
          ./cloudflared tunnel --url http://localhost:8007 --no-autoupdate > cf_log.txt 2>&1 &
          echo "Cloudflare linki oluÅŸturuluyor..."
          for i in $(seq 1 30); do
            sleep 2
            LINK=$(grep -o "https://.*\.trycloudflare\.com" cf_log.txt | head -n1 || true)
            [ -n "$LINK" ] && break
          done
          echo "$LINK" > link.txt

      - name: Upload Cloudflare Web UI Link
        uses: actions/upload-artifact@v4
        with:
          name: cloudflare-webui-link
          path: link.txt

      - name: Keep alive 6 hours
        run: |
          echo "6 saatlik Kali oturumu baÅŸladÄ±. YAML ile ÅŸaka olmaz ğŸ™‚"
          sleep 21600
